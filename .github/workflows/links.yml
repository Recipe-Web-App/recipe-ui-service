name: Check Links

on:
  schedule:
    - cron: '0 0 * * 0' # Weekly on Sundays
  pull_request:
    paths:
      - '**.md'
      - '**.mdx'
      - 'docs/**'
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  link-check:
    name: Check Markdown Links
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Check links in markdown files
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'yes'
          use-verbose-mode: 'no'
          config-file: '.github/markdown-link-check.json'
          folder-path: '.'
          file-path: './README.md, ./CLAUDE.md'
          max-depth: 3

      - name: Create issue if links are broken
        if: failure() && github.event_name == 'schedule'
        uses: actions/github-script@v8
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸ”— Broken Links Detected in Documentation',
              body: `Broken links were detected in the documentation during the automated link check.

            **Action Required:**
            - Review the [workflow run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details
            - Fix or remove broken links
            - Update redirected URLs
            - Consider using relative links for internal documentation

            **Common Causes:**
            - External websites moved or removed content
            - Typos in URLs
            - Repository structure changes
            - Outdated documentation

            This issue was automatically created by the link checker workflow.`,
              labels: ['documentation', 'automated', 'needs-triage']
            });

      - name: Comment on PR if links are broken
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: `## ðŸ”— Broken Links Detected

            This PR contains broken links in markdown files.

            **Please:**
            - Review the [workflow run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details
            - Fix or remove broken links before merging
            - Verify all external links are accessible
            - Consider using relative links for internal references

            Links must be valid before this PR can be merged.`
            });
