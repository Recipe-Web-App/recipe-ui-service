name: License Check

on:
  pull_request:
    branches: [main, develop]
    paths:
      - 'package.json'
      - 'package-lock.json'
  schedule:
    - cron: '0 6 * * 1' # Weekly on Mondays
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  BUN_VERSION: 'latest'

permissions:
  contents: read
  pull-requests: write

jobs:
  license-check:
    name: Check Dependency Licenses
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: üì¶ Setup Bun
        uses: oven-sh/setup-bun@3d267786b128fe76c2f16a390aa2448b815359f3 # v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: üîß Install dependencies
        run: bun install --frozen-lockfile

      - name: Install license-checker
        run: bun add -g license-checker

      - name: Check for forbidden licenses
        id: check
        continue-on-error: true
        run: |
          license-checker --production --json --out licenses.json
          license-checker --production --failOn "GPL-3.0;AGPL-3.0;LGPL-3.0" 2>&1 | tee license-check.txt
          echo "exit_code=${PIPESTATUS[0]}" >> $GITHUB_OUTPUT

      - name: Generate license report
        run: |
          echo "# License Report" > license-report.md
          echo "" >> license-report.md
          echo "## All Dependencies" >> license-report.md
          echo "" >> license-report.md
          license-checker --production --summary >> license-report.md

      - name: Upload license report
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: license-report
          path: |
            license-report.md
            licenses.json
          retention-days: 90

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
        with:
          script: |
            const fs = require('fs');
            const exitCode = '${{ steps.check.outputs.exit_code }}';

            let body = '';

            if (exitCode !== '0') {
              const checkOutput = fs.readFileSync('license-check.txt', 'utf8');
              body = `## ‚ö†Ô∏è License Check Failed

            This PR introduces dependencies with problematic licenses.

            <details>
            <summary>Forbidden License Details</summary>

            \`\`\`
            ${checkOutput}
            \`\`\`

            </details>

            ### Blocked Licenses
            - GPL-3.0 (copyleft - requires source distribution)
            - AGPL-3.0 (network copyleft - requires source for SaaS)
            - LGPL-3.0 (copyleft for libraries)

            Please review these dependencies or seek legal approval.
              `;
            } else {
              body = `## ‚úÖ License Check Passed

            All dependency licenses are compliant.

            [View full license report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
              `;
            }

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: body
            });

      - name: Fail if forbidden licenses found
        if: steps.check.outputs.exit_code != '0'
        run: |
          echo "‚ùå Forbidden licenses detected"
          exit 1
