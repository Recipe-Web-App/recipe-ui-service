name: ğŸ§ª Advanced Testing Suite

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run full test suite daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      test-type:
        description: 'Test type to run'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - e2e
          - visual
          - accessibility
          - performance
          - cross-browser

env:
  BUN_VERSION: 'latest'
  PLAYWRIGHT_BROWSERS_PATH: ~/.cache/playwright

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Job 1: E2E Tests across multiple browsers
  e2e-tests:
    name: ğŸ­ E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: github.event.inputs.test-type == 'all' || github.event.inputs.test-type == 'e2e' || github.event.inputs.test-type == ''

    strategy:
      fail-fast: false
      matrix:
        browser: [chromium, firefox, webkit]
        shard: [1/4, 2/4, 3/4, 4/4]

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: ğŸ“¦ Setup Bun
        uses: oven-sh/setup-bun@3d267786b128fe76c2f16a390aa2448b815359f3 # v2
        with:
          bun-version: ${{ env.BUN_VERSION }}
          cache: true

      - name: ğŸ”§ Install dependencies
        run: bun install --frozen-lockfile

      - name: ğŸ“¥ Get Playwright version
        id: playwright-version
        run: echo "version=$(bunx playwright --version | cut -d' ' -f2)" >> $GITHUB_OUTPUT

      - name: ğŸ­ Cache Playwright browsers
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5
        id: playwright-cache
        with:
          path: ${{ env.PLAYWRIGHT_BROWSERS_PATH }}
          key: playwright-${{ runner.os }}-${{ steps.playwright-version.outputs.version }}

      - name: ğŸ­ Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: bunx playwright install --with-deps

      - name: ğŸ—ï¸ Build application
        run: bun run build

      - name: ğŸš€ Start application
        run: |
          bun run start &
          bunx wait-on http://localhost:3000 --timeout 60000
        env:
          CI: true

      - name: ğŸ§ª Run E2E tests
        run: |
          bunx playwright test tests/e2e \
            --project=${{ matrix.browser }} \
            --shard=${{ matrix.shard }} \
            --reporter=blob
        env:
          CI: true

      - name: ğŸ“¤ Upload blob report
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        if: always()
        with:
          name: blob-report-${{ matrix.browser }}-${{ strategy.job-index }}
          path: blob-report
          retention-days: 7

  # Job 2: Merge E2E Test Reports
  merge-e2e-reports:
    name: ğŸ“Š Merge E2E Reports
    runs-on: ubuntu-latest
    needs: e2e-tests
    if: always()

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: ğŸ“¦ Setup Bun
        uses: oven-sh/setup-bun@3d267786b128fe76c2f16a390aa2448b815359f3 # v2
        with:
          bun-version: ${{ env.BUN_VERSION }}
          cache: true

      - name: ğŸ”§ Install dependencies
        run: bun install --frozen-lockfile

      - name: ğŸ“¥ Download blob reports
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7
        with:
          path: all-blob-reports
          pattern: blob-report-*
          merge-multiple: true

      - name: ğŸ“Š Merge reports
        run: bunx playwright merge-reports --reporter html ./all-blob-reports

      - name: ğŸ“¤ Upload HTML report
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: e2e-test-report
          path: playwright-report/
          retention-days: 30

      - name: ğŸ’¬ Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
        with:
          script: |
            const fs = require('fs');
            const path = './playwright-report/index.html';

            if (fs.existsSync(path)) {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: 'ğŸ­ **E2E Test Results**\n\nTest report is available in the artifacts section of this workflow run.'
              });
            }

  # Job 3: Visual Regression Testing
  visual-regression:
    name: ğŸ‘ï¸ Visual Regression
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: github.event.inputs.test-type == 'all' || github.event.inputs.test-type == 'visual' || github.event.inputs.test-type == ''

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: ğŸ“¦ Setup Bun
        uses: oven-sh/setup-bun@3d267786b128fe76c2f16a390aa2448b815359f3 # v2
        with:
          bun-version: ${{ env.BUN_VERSION }}
          cache: true

      - name: ğŸ”§ Install dependencies
        run: bun install --frozen-lockfile

      - name: ğŸ­ Install Playwright
        run: bunx playwright install --with-deps chromium

      - name: ğŸ—ï¸ Build application
        run: bun run build

      - name: ğŸš€ Start application
        run: |
          bun run start &
          bunx wait-on http://localhost:3000 --timeout 60000
        env:
          CI: true

      - name: ğŸ‘ï¸ Run visual tests
        run: bun run test:visual

      - name: ğŸ“¤ Upload visual test results
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: visual-test-results
          path: |
            test-results/
            tests/visual/screenshots/
          retention-days: 30

  # Job 4: Accessibility Testing
  accessibility-tests:
    name: â™¿ Accessibility Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: github.event.inputs.test-type == 'all' || github.event.inputs.test-type == 'accessibility' || github.event.inputs.test-type == ''

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: ğŸ“¦ Setup Bun
        uses: oven-sh/setup-bun@3d267786b128fe76c2f16a390aa2448b815359f3 # v2
        with:
          bun-version: ${{ env.BUN_VERSION }}
          cache: true

      - name: ğŸ”§ Install dependencies
        run: bun install --frozen-lockfile

      - name: ğŸ­ Install Playwright
        run: bunx playwright install --with-deps chromium

      - name: ğŸ—ï¸ Build application
        run: bun run build

      - name: ğŸš€ Start application
        run: |
          bun run start &
          bunx wait-on http://localhost:3000 --timeout 60000
        env:
          CI: true

      - name: â™¿ Run accessibility tests
        run: bun run test:a11y

      - name: ğŸ“Š Generate accessibility report
        if: always()
        run: |
          echo "# Accessibility Test Results" > accessibility-report.md
          echo "Tests completed on $(date)" >> accessibility-report.md
          echo "Check the detailed results in the artifacts." >> accessibility-report.md

      - name: ğŸ“¤ Upload accessibility results
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: accessibility-test-results
          path: |
            test-results/
            accessibility-report.md
          retention-days: 30

  # Job 5: Performance Testing
  performance-tests:
    name: âš¡ Performance Tests
    runs-on: ubuntu-latest
    timeout-minutes: 25
    if: github.event.inputs.test-type == 'all' || github.event.inputs.test-type == 'performance' || github.event.inputs.test-type == ''

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: ğŸ“¦ Setup Bun
        uses: oven-sh/setup-bun@3d267786b128fe76c2f16a390aa2448b815359f3 # v2
        with:
          bun-version: ${{ env.BUN_VERSION }}
          cache: true

      - name: ğŸ”§ Install dependencies
        run: bun install --frozen-lockfile

      - name: ğŸ­ Install Playwright
        run: bunx playwright install --with-deps chromium

      - name: ğŸ—ï¸ Build application
        run: bun run build

      - name: ğŸš€ Start application
        run: |
          bun run start &
          bunx wait-on http://localhost:3000 --timeout 60000
        env:
          CI: true

      - name: âš¡ Core Web Vitals tests
        run: bun run perf:vitals

      - name: ğŸ“Š Lighthouse performance audit
        run: bun run perf:lighthouse

      - name: ğŸ”„ Load testing
        run: bun run perf:load

      - name: ğŸ“ˆ Performance budget check
        run: |
          echo "Checking performance budgets..."
          bun run size-limit
          echo "âœ… Performance budgets validated"

      - name: ğŸ“¤ Upload performance results
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: performance-test-results
          path: |
            .lighthouseci/
            performance-results/
            test-results/
          retention-days: 30

  # Job 6: Cross-Browser Testing
  cross-browser:
    name: ğŸŒ Cross-Browser Tests
    runs-on: ${{ matrix.os }}
    timeout-minutes: 25
    if: github.event.inputs.test-type == 'all' || github.event.inputs.test-type == 'cross-browser' || github.event.inputs.test-type == ''

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        browser: [chromium, firefox, webkit]
        exclude:
          # WebKit on Linux sometimes has issues in CI
          - os: ubuntu-latest
            browser: webkit

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

          bun run start &
          npx wait-on http://localhost:3000 --timeout 60000
        shell: bash
        env:
          CI: true

      - name: ğŸ§ª Run cross-browser tests
        run: npx playwright test tests/e2e/critical-paths --project=${{ matrix.browser }}

      - name: ğŸ“¤ Upload test results
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: cross-browser-results-${{ matrix.os }}-${{ matrix.browser }}
          path: |
            test-results/
            playwright-report/
          retention-days: 7

  # Job 7: Mobile Testing
  mobile-tests:
    name: ğŸ“± Mobile Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: github.event.inputs.test-type == 'all' || github.event.inputs.test-type == ''

    strategy:
      matrix:
        device: ['iPhone 13', 'Pixel 5', 'iPad Pro']

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6
        with:
          node-version: ${{ env.NODE_VERSION }}
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: ğŸ“¦ Setup Bun
        uses: oven-sh/setup-bun@3d267786b128fe76c2f16a390aa2448b815359f3 # v2
        with:
          bun-version: ${{ env.BUN_VERSION }}
          cache: true

      - name: ğŸ”§ Install dependencies
        run: bun install --frozen-lockfile

      - name: ğŸ­ Install Playwright Browsers
        run: bunx playwright install --with-deps chromium

      - name: ğŸ—ï¸ Build application
        run: bun run build

      - name: ğŸš€ Start application
        run: |
          bun run start &
          bunx wait-on http://localhost:3000 --timeout 60000
        env:
          CI: true

      - name: ğŸ“± Run mobile tests
        run: |
          bunx playwright test tests/e2e/critical-paths \
            --project=chromium \
            --global-timeout=300000 \
            --config=playwright.config.ts
        env:
          DEVICE: ${{ matrix.device }}

      - name: ğŸ“¤ Upload mobile test results
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: mobile-test-results-${{ matrix.device }}
          path: |
            test-results/
            screenshots/
          retention-days: 7

  # Consolidation Job
  test-suite-summary:
    name: ğŸ“‹ Test Suite Summary
    runs-on: ubuntu-latest
    if: always()
    needs:
      - merge-e2e-reports
      - visual-regression
      - accessibility-tests
      - performance-tests
      - cross-browser
      - mobile-tests

    steps:
      - name: ğŸ“Š Generate summary report
        run: |
          echo "# ğŸ§ª Test Suite Summary" > test-summary.md
          echo "" >> test-summary.md
          echo "## Test Results" >> test-summary.md
          echo "- E2E Tests: ${{ needs.merge-e2e-reports.result }}" >> test-summary.md
          echo "- Visual Regression: ${{ needs.visual-regression.result }}" >> test-summary.md
          echo "- Accessibility: ${{ needs.accessibility-tests.result }}" >> test-summary.md
          echo "- Performance: ${{ needs.performance-tests.result }}" >> test-summary.md
          echo "- Cross-Browser: ${{ needs.cross-browser.result }}" >> test-summary.md
          echo "- Mobile: ${{ needs.mobile-tests.result }}" >> test-summary.md
          echo "" >> test-summary.md
          echo "Generated on: $(date)" >> test-summary.md

      - name: ğŸ“¤ Upload summary
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: test-suite-summary
          path: test-summary.md
          retention-days: 30

      - name: ğŸ‰ All tests passed
        if: ${{ !contains(needs.*.result, 'failure') && !contains(needs.*.result, 'cancelled') }}
        run: |
          echo "ğŸ‰ All advanced tests passed successfully!"
          echo "âœ… E2E tests completed"
          echo "ğŸ‘ï¸ Visual regression tests passed"
          echo "â™¿ Accessibility tests passed"
          echo "âš¡ Performance tests passed"
          echo "ğŸŒ Cross-browser tests passed"
          echo "ğŸ“± Mobile tests passed"

      - name: âŒ Some tests failed
        if: ${{ contains(needs.*.result, 'failure') }}
        run: |
          echo "âŒ Some advanced tests failed. Please review the logs and artifacts."
          exit 1

      - name: ğŸ“¬ Notify team
        if: always() && github.ref == 'refs/heads/main'
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: |
            ğŸ§ª Advanced Test Suite Results for ${{ github.repository }}
            - E2E: ${{ needs.merge-e2e-reports.result }}
            - Visual: ${{ needs.visual-regression.result }}
            - A11y: ${{ needs.accessibility-tests.result }}
            - Perf: ${{ needs.performance-tests.result }}
            - Cross-browser: ${{ needs.cross-browser.result }}
            - Mobile: ${{ needs.mobile-tests.result }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
